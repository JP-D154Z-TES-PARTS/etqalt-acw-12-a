# baseフォルダ仕様書とl_mat.cの対応関係

## 概要
このドキュメントは、baseフォルダの仕様書（52etqalt-acw-11-b.xlsx）とソースコード（etqalt_l_mat.c）の対応関係を説明します。

## ファイル構成

### 仕様書ファイル
- `base/etqalt-acw-11-b_spec/52etqalt-acw-11-b.xlsx` - メイン仕様書
- `base/etqalt-acw-11-b_spec/document/ロジック変更シート_ver9.06_etqalt.xlsx` - ロジック変更履歴
- `base/etqalt-acw-11-b_spec/document/参照元チェックシート_ver2.08_etqalt-acw-11-b.xlsx` - 参照チェック

### ソースコードファイル
- `base/etqalt-acw-11-b_src/etqalt.h` - ヘッダファイル（型定義、関数プロトタイプ、extern宣言）
- `base/etqalt-acw-11-b_src/etqalt_c_mat.c` - 定数・マップデータファイル
- `base/etqalt-acw-11-b_src/etqalt_l_mat.c` - ロジック実装ファイル

## 仕様書とソースコードの対応

### 1. 定数の対応（etqalt_c_mat.c）

仕様書の「≪ 定数 ≫」セクションとetqalt_c_mat.cの定数定義が対応:

#### 仕様書の定数記述例:
```
名前: etqalt_NEGD
バリュー: 200
単位: rpm
内容: NE下限ガード値
型: s2s
lsb: (12800*2)/128/256
```

#### etqalt_c_mat.cでの実装:
```c
volatile const s2 s2s_etqalt_NEGD = s2g_ELSB_NE(200.);  /* lsb=(12800*2)/128/256,unit=rpm :NE下限ガード値 */
```

### 2. マップの対応（etqalt_c_mat.c）

仕様書の「≪ マップ ≫」セクションとetqalt_c_mat.cのマップデータが対応:

#### 主要マップ:
- `etqalt_ektqalt_map[]` - 目標オルタトルク回転補正マップ
- `etqalt_ecaltst_map[]` - 始動経過時間判定値マップ
- `etqalt_epwrfan_map[]` - 電動ファン電力マップ（PWM電動ファン有効時）
- `etqalt_epwaltsocb_map[]` - 目標電力充電率バッテリ補正量マップ（充電制御有効時）
- `etqalt_eifint_map[]` - 初期充電電流マップ

### 3. ロジックの対応（etqalt_l_mat.c）

#### 関数構成:
```c
void vdg_etqalt_pwon_seq(void);    // 電源立上げ処理
void vdg_etqalt_16msl_seq(void);   // 電気負荷トルクの算出（16ms周期）
void vdg_etqalt_65msl_seq(void);   // バッテリ電圧の算出（65ms周期）
```

#### 主要処理フロー（vdg_etqalt_16msl_seq）:

1. **電動ファン電力計算** (epwrfan)
   - ON/OFFファンまたはPWMファンの状態から電力を算出

2. **電気負荷要求ベース値計算** (epwrelsrqb)
   - 各種電気負荷（ELS1-5, PS, AC, AI, PTCヒータ等）の合計
   - コンパイルスイッチ（JEELS2, JEELS3, JEELS4, JEPS, JEAI, JEPTCHT_E）により条件付きコンパイル

3. **オルタ充電電流平滑化** (ealtifsm)
   - 始動後、バッテリ電圧正常時にLIN通信で取得した充電電流を平滑化
   - それ以外は水温マップから初期値を取得

4. **目標オルタトルクベース値計算** (etqalttb)
   - オルタ充電トルク（yaltinfo_yalttrq）をベースに
   - 回転数補正スイッチ（XKNE_USE）が有効な場合、実回転数/目標回転数で補正
   - ヒステリシス処理により急変を抑制

5. **目標オルタトルク計算** (etqaltt)
   - 3次元マップ（回転数×充電電流×バッテリ電圧）から補正係数を取得
   - etqalttb × 補正係数 = etqaltt

6. **オルタ電力計算** (epwralt)
   - トルク→電力変換マクロ（ELIB_CONV_TTOP）使用

7. **充電制御対応** (epwaltsocb, epwaltsoc) ※JEALTCNT有効時のみ
   - 始動後一定時間経過後、オルタ充電増加時にマップから補正量を算出
   - 充電増加中は減衰処理

8. **電気負荷要求計算** (epwrelsrq)
   - ベース値変化量から電圧補正を実施
   - 減衰処理判定と減衰率適用

9. **電気負荷電力計算** (epwrels)
   - max(epwrelsrq, epwralt + epwaltsoc)

10. **目標電気負荷トルク計算** (etqelst)
    - 電力→トルク変換
    - ガードバンド処理（急変時は大きく、定常時は小さく）

11. **最終オルタトルク出力** (etqalt)
    - 回転数補正スイッチ有効時は実回転数/目標回転数で補正

### 4. コンパイルスイッチと仕様の関係

#### 主要コンパイルスイッチ（ejcc.h で定義）:
- `JEFAN` - 電動ファン仕様（NOT_USE/ONOFF_FAN/PWM_FAN）
- `JEELS2` - 電気負荷2有効/無効
- `JEELS3` - 電気負荷3有効/無効（高電力負荷1）
- `JEELS4` - 電気負荷4有効/無効（高電力負荷2）
- `JEPS` - 電動PSモータ有効/無効
- `JEAI` - AIイドル有効/無効
- `JEALTCNT` - 充電制御有効/無効
- `JEPTCHT_E` - PTCヒータ有効/無効

これらのスイッチにより、車両仕様に応じて必要な処理のみをコンパイルする。

### 5. 入出力インターフェース

#### 主要入力:
- `s2g_yaltinfo_yalttrq` - オルタ充電トルク（LIN通信）
- `u1g_yaltinfo_yaltif` - オルタ充電電流（LIN通信）
- `s2g_ene_ene` - エンジン回転数
- `s2g_emnet_enet` - 目標エンジン回転数
- `s2g_ethw_ethwst` - 水温
- `s2g_cpowif_b` - バッテリ電圧
- 各種電気負荷状態信号（exdly_exels, eacstate_exac 等）

#### 主要出力:
- `s2g_etqalt_etqalt` - 現在オルタトルク（s2型）
- `f4g_etqalt_etqalt` - 現在オルタトルク（f4型）
- `s2g_etqalt_etqaltisc[]` - ISCオルタトルク（目標・現在）
- `f4g_etqalt_etqaltisc[]` - ISCオルタトルク（目標・現在、f4型）
- `f4g_etqalt_epwralt` - オルタ電力

## バージョン履歴との対応

### acw-11-b (base)
- 仕様確認書対応（TE-STD-34B-402722-0318、TE-STD-34B-402723-0019）
- 2024/8/5

### acw-12-a (new)
- サイバーセキュリティー対応（CERT C準拠）
- 定数・ロジックの機能的変更なし
- 2025/7/14

## まとめ

1. **定数ファイル（c_mat.c）**: 仕様書の定数・マップセクションと1:1対応
2. **ロジックファイル（l_mat.c）**: 仕様書の機能説明を実装、コンパイルスイッチで車両仕様対応
3. **バージョン管理**: ファイル先頭のコメントで識別（例: /* etqalt-pcw00-1200-a-M3 */）
4. **エンコーディング**: CP932（日本語コメント表示のため）

acw-11-b から acw-12-a への更新は、CERT C準拠のためのコーディング規約対応のみで、
定数値やロジックの機能的変更はないため、バージョン識別子の更新のみで対応可能です。
