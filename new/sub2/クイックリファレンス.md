# クイックリファレンス: 仕様書とコード対応関係

## 基本情報

| 項目 | 内容 |
|------|------|
| 仕様書 | base/etqalt-acw-11-b_spec/52etqalt-acw-11-b.docx |
| ソースコード | base/etqalt-acw-11-b_src/etqalt_l_mat.c (635行) |
| モジュール名 | 電気負荷トルク（etqalt） |
| 主要機能 | ISC制御用オルタトルク算出 |
| 対応率 | **100%完全一致** |

---

## 関数クイックリファレンス

### 1. vdg_etqalt_pwon_seq()
- **タイミング**: pwon（電源ON時）
- **処理**: 初期化処理
- **仕様**: セクション「初期値」
- **コード**: 150-155行目

### 2. vdg_etqalt_16msl_seq()
- **タイミング**: 16ms周期
- **処理**: メイン処理（トルク・電気負荷算出）
- **仕様**: セクション1～5
- **コード**: 165-622行目
- **主要処理**:
  - 目標オルタトルク算出
  - 電気負荷動力算出
  - ISC目標トルク算出

### 3. vdg_etqalt_65msl_seq()
- **タイミング**: 65ms周期
- **処理**: バッテリ電圧スムージング
- **仕様**: セクション2-1「ここで」
- **コード**: 629-633行目

---

## 変数クイックリファレンス

### 公開変数（4個）

| 変数名 | 説明 | 型 | 単位 |
|--------|------|-----|------|
| `s2g_etqalt_etqalt` | 現在オルタトルク | s2 | Nm |
| `s2g_etqalt_etqaltisc[0]` | ISC目標トルク(将来) | s2 | Nm |
| `s2g_etqalt_etqaltisc[1]` | ISC目標トルク(直近) | s2 | Nm |
| `f4g_etqalt_epwralt` | オルタパワー | f4 | kW |

### 主要内部変数（static）

| 変数名 | 説明 | 型 | 単位 |
|--------|------|-----|------|
| `s2s_etqalt_etqalttb` | 目標オルタトルクベース値 | s2 | Nm |
| `s2s_etqalt_etqaltt` | 目標オルタトルク | s2 | Nm |
| `s2s_etqalt_etqelst` | 目標電気負荷トルク | s2 | Nm |
| `s2s_etqalt_epwrelsrqb` | 電気負荷動力ベース値 | s2 | kW |
| `s2s_etqalt_epwrelsrq` | SW入力電気負荷動力 | s2 | kW |
| `s2s_etqalt_ebattsm` | バッテリ電圧 | s2 | V |

---

## 処理フロークイックガイド

### メイン処理（16ms周期）の流れ

```
1. 目標オルタトルクベース値算出 (etqalttb)
   ↓
2. 目標オルタトルク算出 (etqaltt) ← マップ補正
   ↓
3. オルタパワー算出 (epwralt) ← トルク→パワー変換
   ↓
4. 電気負荷動力ベース値算出 (epwrelsrqb) ← 各負荷積算
   ├─ 電動ファン
   ├─ 電気負荷1～4
   ├─ 高電気負荷1～5
   ├─ 電動PS
   ├─ エアコン
   ├─ エアポンプ
   └─ PTCヒータ
   ↓
5. SW入力電気負荷動力算出 (epwrelsrq) ← 減衰処理適用
   ↓
6. 電気負荷動力算出 (epwrels) ← 最大値選択
   ↓
7. 目標電気負荷トルク算出 (etqelst) ← ガード処理
   ↓
8. ISC目標トルク算出 (etqaltisc[0][1])
   ↓
9. 現在オルタトルク算出 (etqalt) ← 回転数補正
```

---

## 主要アルゴリズムクイックリファレンス

### 目標オルタトルク算出（セクション3）

```
etqaltt = etqalttb × t_ktqalt
  where: t_ktqalt = ektqalt_map(ene_ene)
```

**コード**: 225-232行目

---

### 目標電気負荷トルク算出（セクション2-1）

```
etqelst = GUARD(etqelstb, t_tqgdlo, t_tqgdhi)
```

**ガード値算出**:
- 偏差小時: ±0.03125 Nm
- 偏差大時: ±20 Nm

**コード**: 587-591行目

---

### 減衰処理（セクション4-1）

```
if (expwrdec == ON):
    epwrelsrq = t_pwrelsrq × 0.975  # 減衰率適用
else:
    epwrelsrq = t_pwrelsrq
```

**コード**: 527-537行目

---

### バッテリ電圧スムージング（セクション2-1）

```
ebattsm = ebattsm + (cpowif_b - ebattsm) / BATNSM
```

**コード**: 632行目

---

## コンパイルスイッチクイックガイド

| スイッチ | 機能 | 影響 |
|---------|------|------|
| `JEALTCNT` | 充電制御 | SOC補正処理 |
| `JEFAN` | 電動ファン | ON/OFF/PWM方式 |
| `JEELS2` | 電気負荷2 | 負荷積算 |
| `JEELS3` | 高電気負荷1 | 負荷積算 |
| `JEELS4` | 高電気負荷2 | 負荷積算 |
| `JEPS` | 電動PS | 負荷積算 |
| `JEAI` | エアポンプ | 負荷積算 |
| `JEPTCHT_E` | PTCヒータ | 負荷積算 |

---

## 主要定数クイックリファレンス

| 定数名 | 説明 | 例示値 |
|--------|------|--------|
| `etqalt_BATINT` | バッテリ電圧初期値 | 12 V |
| `etqalt_NEGD` | 回転数下限ガード | 200 rpm |
| `etqalt_TQHYS` | トルクヒステリシス | 0.3 Nm |
| `etqalt_TQINT` | トルク初期値 | 3 Nm |
| `etqalt_DLGDMNL/H` | トルクガード最小 | ±0.03125 Nm |
| `etqalt_DLGDMXL/H` | トルクガード最大 | ±20 Nm |
| `etqalt_DECRTO` | 減衰率 | 0.975 |
| `etqalt_PWRELSGD` | 電気負荷上限 | 1.5 kW |

---

## よく使うライブラリ関数

| 関数名 | 機能 | 使用例 |
|-------|------|--------|
| `s2g_glsmth_s2s2s2()` | スムージング | バッテリ電圧、トルクなまし |
| `s4g_glmul_s2s2()` | 乗算 | トルク×回転数 |
| `s2g_gldiv_s4s2()` | 除算 | トルク÷回転数 |
| `ELIB_HILOGD2()` | 上下限ガード | トルク・パワーガード |
| `ELIB_MAXSLCT2()` | 最大値選択 | 電気負荷動力選択 |
| `ELIB_CONV_PTOT()` | パワー→トルク | 電気負荷トルク変換 |
| `ELIB_CONV_TTOP()` | トルク→パワー | オルタパワー変換 |

---

## トラブルシューティング

### Q1: オルタトルクが更新されない

**確認ポイント**:
1. 始動後経過時間（`exst_ecast_16m >= ecast`）
2. バッテリ異常フラグ（`wbatt_fdi_xbattClFt == OFF`）
3. 電圧低下フラグ（`yaltlmp_yxbattlo == OFF`）【充電制御有】

**該当コード**: 195-198行目

---

### Q2: 電気負荷が反映されない

**確認ポイント**:
1. 各電気負荷信号の状態（`exdly_exels`等）
2. コンパイルスイッチの設定（`JEELS2`, `JEFAN`等）
3. 電気負荷定数値（`etqalt_PWRELS`等）

**該当コード**: 385-468行目

---

### Q3: 減衰処理が動作しない

**確認ポイント**:
1. 減衰フラグ（`expwrdec`）のセット/クリア条件
2. ディレーカウンタ（`ecdecdly_16m`）
3. ベース要求値変化量（`t_dlpwrrqb`）

**該当コード**: 506-523行目

---

## 詳細ドキュメント参照先

- **包括的マッピング**: `仕様書コード対応マッピング.md`
- **関数詳細対応**: `関数仕様コード対応表.md`
- **タスク概要**: `README.md`

---

**作成日**: 2025-10-17  
**バージョン**: 1.0
